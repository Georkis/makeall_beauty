{% extends "frontend.html.twig" %}

{% block title %}Compra: {{ categoria }}{% endblock %}

{% block body_estrecho %}
    <h4 class="bg-secondary p-2" style="color: #FFF">{{ categoria }}</h4>
    <hr>
    <div class="row featured__filter" id="contenido">
        {% for p in products %}
            <div class="col-lg-3 col-md-4 col-sm-6 mix oranges fresh-meat">
                <div class="featured__item">
                    <div class="featured__item__pic set-bg thumbnail" data-setbg="{{ asset('images/' ~ p.image) }}">
                        <ul class="featured__item__pic__hover">
                            <li><a onclick="likePlus(this); return false;" href="{{ path('default_like_product', { 'id' : p.id }) }}"><i class="fa fa-heart"></i></a></li>
                            <li><a href="{{ path('default_product', {'id': p.id}) }}"><i class="fa fa-link"></i></a></li>
                        </ul>
                    </div>
                    <div class="featured__item__text">
                        <h6><a href="{{ path('default_product', {'id': p.id}) }}">{{ p }}</a></h6>
                        <h5>${{ p.price }} USD</h5>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
    <div class="row featured__filter d-none mb-5" id="paginate-contenido">
        <a onclick="getProducts(this); return false;" id="previous" href="" class="btn btn-outline-danger"><i class="fa fa-angle-left"></i></a>
        <span id="pages-paginate"></span>
        <a onclick="getProducts(this); return false;" id="next" href="" class="btn btn-outline-danger ml-2"><i class="fa fa-angle-right"></i></a>
        <span id="label-pages" class="mt-2 ml-3"></span>
    </div>
{% endblock %}
{% block js %}
    <script src="{{ asset('js/functions.js') }}"></script>
    <script>
        function getProducts(urlApi){
            $.ajax({
                url: urlApi,
                method: 'GET',
                beforeSend: function () {
                    $('#contenido').html('<p class="text-center"><i class="fa fa-spinner fa-pulse"></i> cargando</p>');
                },
            }).done(function (response) {
                var products = response['hydra:member'];
                var total = response['hydra:totalItems'];
                var pageSize = 1;
                if (total > pageSize) {
                    var view = response['hydra:view'];
                    var next = view['hydra:next'];
                    var first = view['hydra:first'];
                    var last = view['hydra:last'];
                    var previous = view['hydra:previous'];
                    var idVar = view['@id'];
                    console.log(idVar);
                    var page = idVar.substring(idVar.indexOf("page="));
                    var pageCurrent = page.substring(page.indexOf("=")+1);

                    var pageCont =Math.ceil(total/pageSize);
                    $('#pages-paginate').children().remove();
                    for (let i = 1; i <= pageCont; i++){
                        $('#pages-paginate').append(
                            '<a onclick="getProducts(this); return false;" href="/api/products?categoryProduct={{ categoria.id }}&public=true&page='+i+'" class="btn btn-'+(pageCurrent == i ? 'danger' : 'outline-danger')+' ml-1">'+i+'</a>'
                        );
                    }

                    if (first == idVar){
                        $('#previous').attr('href', '').addClass('disabled').addClass('btn-gray');
                    }else {
                        $('#previous').removeClass('disabled').removeClass('btn-gray');
                    }
                    if (last == idVar){
                        $('#next').attr('href', '#').addClass('disabled').addClass('btn-gray');
                    }else {
                        $('#next').removeClass('disabled').removeClass('btn-gray');
                    }

                    $('#next').attr('href', next);
                    $('#previous').attr('href', previous ?? idVar);

                    $('#paginate-contenido').removeClass('d-none');
                    console.log(response);

                    $('#label-pages').html(
                        'Pagina: '+ pageCurrent +' - '+ total
                    );

                    $('#contenido').children().remove();
                    for (let i = 0; i < products.length; i++){
                        let image = "/images/"+products[i]['image'];
                        $('#contenido').append(
                            '<div class="col-lg-3 col-md-4 col-sm-6 mix oranges fresh-meat">' +
                                '<div class="featured__item">' +
                                    '<div class="featured__item__pic set-bg thumbnail" data-setbg="'+image+'" style="background-image: url('+image+');">' +
                                        '<ul class="featured__item__pic__hover">' +
                                            '<li><a onclick="likePlus(this); return false;" href="/like/product/'+products[i]['id']+'"><i class="fa fa-heart"></i></a></li>' +
                                            '<li><a href="/producto/'+products[i]['id']+'"><i class="fa fa-link"></i></a></li>' +
                                        '</ul>' +
                                    '</div>' +
                                    '<div class="featured__item__text">' +
                                        '<h6><a href="/producto/'+products[i]['id']+'">'+products[i]['name']+'</a></h6>\n' +
                                        '<h5>US$ '+products[i]['price']+'</h5>\n' +
                                    '</div' +
                                '</div>' +
                            '</div>'
                        );
                    }
                }else {
                    for (let i = 0; i < products.length; i++){
                        let image = "/images/"+products[i]['image'];
                        $('#contenido').append(
                            '<div class="col-lg-3 col-md-4 col-sm-6 mix oranges fresh-meat">' +
                                '<div class="featured__item">' +
                                    '<div class="featured__item__pic set-bg thumbnail" data-setbg="'+image+'" style="background-image: url('+image+');">' +
                                        '<ul class="featured__item__pic__hover">' +
                                            '<li><a onclick="likePlus(this); return false;" href="/like/product/'+products[i]['id']+'"><i class="fa fa-heart"></i></a></li>' +
                                            '<li><a href="/producto/'+products[i]['id']+'"><i class="fa fa-link"></i></a></li>' +
                                        '</ul>' +
                                    '</div>' +
                                '</div>' +
                            '</div>'
                        );
                    }
                }
            });
        }

        getProducts('/api/products?categoryProduct={{ categoria.id }}?&public=true&page=1');
    </script>
{% endblock %}